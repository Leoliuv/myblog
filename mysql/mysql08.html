<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>对慢查询日志进行分析 | 个人博客</title>
    <meta name="description" content="liulidu">
    <link rel="icon" href="/myblog/image/logo.png">
    
    <link rel="preload" href="/myblog/assets/css/0.styles.c5a6e6d2.css" as="style"><link rel="preload" href="/myblog/assets/js/app.d89ba8c6.js" as="script"><link rel="preload" href="/myblog/assets/js/2.4d65e3a3.js" as="script"><link rel="preload" href="/myblog/assets/js/21.4536d46d.js" as="script"><link rel="prefetch" href="/myblog/assets/js/10.92fdb281.js"><link rel="prefetch" href="/myblog/assets/js/11.1e78a99e.js"><link rel="prefetch" href="/myblog/assets/js/12.03774e1d.js"><link rel="prefetch" href="/myblog/assets/js/13.aaa2525d.js"><link rel="prefetch" href="/myblog/assets/js/14.a9bf3e64.js"><link rel="prefetch" href="/myblog/assets/js/15.070b174f.js"><link rel="prefetch" href="/myblog/assets/js/16.4cb3a0bf.js"><link rel="prefetch" href="/myblog/assets/js/17.b6bab035.js"><link rel="prefetch" href="/myblog/assets/js/18.be402a1a.js"><link rel="prefetch" href="/myblog/assets/js/19.745e56d6.js"><link rel="prefetch" href="/myblog/assets/js/20.ded294f0.js"><link rel="prefetch" href="/myblog/assets/js/22.37f6eaa0.js"><link rel="prefetch" href="/myblog/assets/js/3.870fcab9.js"><link rel="prefetch" href="/myblog/assets/js/4.0615d0ae.js"><link rel="prefetch" href="/myblog/assets/js/5.db2919ce.js"><link rel="prefetch" href="/myblog/assets/js/6.18cce36a.js"><link rel="prefetch" href="/myblog/assets/js/7.161a12b9.js"><link rel="prefetch" href="/myblog/assets/js/8.fdf184c2.js"><link rel="prefetch" href="/myblog/assets/js/9.305d2036.js">
    <link rel="stylesheet" href="/myblog/assets/css/0.styles.c5a6e6d2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/myblog/" class="home-link router-link-active"><!----> <span class="site-name">个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/myblog/" class="nav-link">首页</a></div><div class="nav-item"><a href="/myblog/mysql/" class="nav-link router-link-active">MySQL</a></div><div class="nav-item"><a href="/myblog/" class="nav-link">#####</a></div><div class="nav-item"><a href="/myblog/" class="nav-link">#####</a></div><div class="nav-item"><a href="/myblog/about/" class="nav-link">关于我</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/myblog/" class="nav-link">首页</a></div><div class="nav-item"><a href="/myblog/mysql/" class="nav-link router-link-active">MySQL</a></div><div class="nav-item"><a href="/myblog/" class="nav-link">#####</a></div><div class="nav-item"><a href="/myblog/" class="nav-link">#####</a></div><div class="nav-item"><a href="/myblog/about/" class="nav-link">关于我</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>MySQL学习笔记</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/myblog/mysql/mysql00.html" class="sidebar-link">初始化安装：</a></li><li><a href="/myblog/mysql/mysql01.html" class="sidebar-link">MySQL安装、初始化、启停操作、添加用户、权限管理</a></li><li><a href="/myblog/mysql/mysql02.html" class="sidebar-link">MySQL主从复制配置（异步）</a></li><li><a href="/myblog/mysql/mysql03.html" class="sidebar-link">MySQL同步复制配置</a></li><li><a href="/myblog/mysql/mysql04.html" class="sidebar-link">Mysql 备份操作</a></li><li><a href="/myblog/mysql/mysql04-01.html" class="sidebar-link">xtraback备份与恢复</a></li><li><a href="/myblog/mysql/mysql05.html" class="sidebar-link">MySQL5.7升级</a></li><li><a href="/myblog/mysql/mysql06.html" class="sidebar-link">percona-toolkit工具包安装使用</a></li><li><a href="/myblog/mysql/mysql07.html" class="sidebar-link">MySQL慢日志监控配置</a></li><li><a href="/myblog/mysql/mysql08.html" class="active sidebar-link">对慢查询日志进行分析</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h3 id="对慢查询日志进行分析"><a href="#对慢查询日志进行分析" aria-hidden="true" class="header-anchor">#</a> 对慢查询日志进行分析</h3> <h5 id="_1-使用mysqldumpslow进行分析【第一种方式】"><a href="#_1-使用mysqldumpslow进行分析【第一种方式】" aria-hidden="true" class="header-anchor">#</a> 1. <strong>使用mysqldumpslow进行分析</strong>【第一种方式】</h5> <div class="language- extra-class"><pre class="language-text"><code>mysqldumpslow -t 10  host-172-18-231-118-slow.log  #显示出慢查询日志中最慢的1条sql
</code></pre></div><p><img src="/ph/1570765860161.png" alt="1570765860161"></p> <h5 id="_2-使用pt-query-digest工具进行分析"><a href="#_2-使用pt-query-digest工具进行分析" aria-hidden="true" class="header-anchor">#</a> 2.使用pt-query-digest工具进行分析</h5> <p>mysqldumpslow是mysql安装后就自带的工具，用于分析慢查询日志，但是pt-query-digest却不是mysql自带的，如果想使用pt-query-digest进行慢查询日志的分析，则需要自己安装pt-query-digest。pt-query-digest工具相较于mysqldumpslow功能多一点。</p> <ol><li>通过拷贝工具进行实现</li> <li>查看具体参数作用</li></ol> <div class="language- extra-class"><pre class="language-text"><code>pt-query-digest --help
</code></pre></div><p><img src="/ph/1570772328830.png" alt="1570772328830"></p> <ol start="3"><li><p>使用</p> <div class="language- extra-class"><pre class="language-text"><code>pt-query-digest ./mysql01/mysql/21000/host-172-18-231-118-slow.log
</code></pre></div></li></ol> <p><img src="/ph/1570772455550.png" alt="1570772455550"></p> <p><em>查询结果分为三部分</em></p> <p><strong>第一部分</strong>：显示出了日志的时间范围，以及总的sql数量和不同的sql数量。</p> <p><strong>第二部分</strong>：显示出统计信息。</p> <p><strong>第三部分</strong>：每一个sql具体的分析</p> <p>pct是percent的简写，表示占的百分比</p> <p>cout是占总sql个数的百分比，exec time 是占总执行时间的百分比，lock time 表示占总的锁表时间的百分比。</p> <ol start="4"><li>分析</li></ol> <div class="language- extra-class"><pre class="language-text"><code>1）查询次数多且每次查询占用时间长的sql
通常为pt-query-digest分析的前几个查询

2）IO消耗大的sql
注意pt-query-digest分析中的Rows examine项

3）为命中索引的sql
注意pt-query-digest分析中Rows examine（扫描行数） 和 Rows sent （发送行数）的对比 ，如果扫描行数远远大于发送行数，则说明索引命中率并不高。
</code></pre></div><h5 id="_3-优化sql"><a href="#_3-优化sql" aria-hidden="true" class="header-anchor">#</a> 3. 优化SQL</h5> <h6 id="_1-使用explain查询sql的执行计划"><a href="#_1-使用explain查询sql的执行计划" aria-hidden="true" class="header-anchor">#</a> 1. 使用explain查询sql的执行计划</h6> <div class="language- extra-class"><pre class="language-text"><code>use test01;
explain select name,age from test01;
</code></pre></div><p><img src="/ph/1570773017867.png" alt="1570773017867"></p> <p>参数列表：</p> <ul><li>table：表示属于哪张数据表</li> <li>type：最重要的参数，表示连接使用了何种类型。从最好到最差的连接类型为const，eq_reg，ref，range，index和ALL。</li> <li>possible_keys：显示可能应用在这张表中的索引。如果为null，则表示没有可能的索引。</li> <li>key：实际使用的索引。如果为null，则表示没有使用索引。</li> <li>key_len：使用的索引的长度，在不损失精确性的情况下，长度越短越好。</li> <li>ref：表示索引的哪一列被使用了，如果可能的话，是一个常数。</li> <li>rows：Mysql认为必须检查的用来返回请求数据的行数。</li></ul> <h6 id="_2-子查询优化"><a href="#_2-子查询优化" aria-hidden="true" class="header-anchor">#</a> 2.子查询优化</h6> <p>通常情况下，需要把子查询优化为join查询，但在优化时要注意关联键是否有一对多的关系，如果有，是可能会出现重复数据的。所以如果存在一对多关系，则应该使用distinct进行限制。</p> <div class="language- extra-class"><pre class="language-text"><code>eg:
select t.id from t where t.id in (select k.kid from k);
优化：
select distinct t.id from t join k on t.id = k.kid;
</code></pre></div><h6 id="对索引的优化"><a href="#对索引的优化" aria-hidden="true" class="header-anchor">#</a> 对索引的优化</h6> <ol><li>选择合适的列建立索引</li> <li>索引优化SQL的方法</li> <li>索引维护</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/myblog/mysql/mysql07.html" class="prev">
          MySQL慢日志监控配置
        </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/myblog/assets/js/app.d89ba8c6.js" defer></script><script src="/myblog/assets/js/2.4d65e3a3.js" defer></script><script src="/myblog/assets/js/21.4536d46d.js" defer></script>
  </body>
</html>
