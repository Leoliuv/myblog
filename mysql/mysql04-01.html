<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>xtraback备份与恢复 | 个人博客</title>
    <meta name="description" content="liulidu">
    <link rel="icon" href="/myblog/image/logo.png">
    
    <link rel="preload" href="/myblog/assets/css/0.styles.c5a6e6d2.css" as="style"><link rel="preload" href="/myblog/assets/js/app.d89ba8c6.js" as="script"><link rel="preload" href="/myblog/assets/js/2.4d65e3a3.js" as="script"><link rel="preload" href="/myblog/assets/js/16.4cb3a0bf.js" as="script"><link rel="prefetch" href="/myblog/assets/js/10.92fdb281.js"><link rel="prefetch" href="/myblog/assets/js/11.1e78a99e.js"><link rel="prefetch" href="/myblog/assets/js/12.03774e1d.js"><link rel="prefetch" href="/myblog/assets/js/13.aaa2525d.js"><link rel="prefetch" href="/myblog/assets/js/14.a9bf3e64.js"><link rel="prefetch" href="/myblog/assets/js/15.070b174f.js"><link rel="prefetch" href="/myblog/assets/js/17.b6bab035.js"><link rel="prefetch" href="/myblog/assets/js/18.be402a1a.js"><link rel="prefetch" href="/myblog/assets/js/19.745e56d6.js"><link rel="prefetch" href="/myblog/assets/js/20.ded294f0.js"><link rel="prefetch" href="/myblog/assets/js/21.4536d46d.js"><link rel="prefetch" href="/myblog/assets/js/22.37f6eaa0.js"><link rel="prefetch" href="/myblog/assets/js/3.870fcab9.js"><link rel="prefetch" href="/myblog/assets/js/4.0615d0ae.js"><link rel="prefetch" href="/myblog/assets/js/5.db2919ce.js"><link rel="prefetch" href="/myblog/assets/js/6.18cce36a.js"><link rel="prefetch" href="/myblog/assets/js/7.161a12b9.js"><link rel="prefetch" href="/myblog/assets/js/8.fdf184c2.js"><link rel="prefetch" href="/myblog/assets/js/9.305d2036.js">
    <link rel="stylesheet" href="/myblog/assets/css/0.styles.c5a6e6d2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/myblog/" class="home-link router-link-active"><!----> <span class="site-name">个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/myblog/" class="nav-link">首页</a></div><div class="nav-item"><a href="/myblog/mysql/" class="nav-link router-link-active">MySQL</a></div><div class="nav-item"><a href="/myblog/" class="nav-link">#####</a></div><div class="nav-item"><a href="/myblog/" class="nav-link">#####</a></div><div class="nav-item"><a href="/myblog/about/" class="nav-link">关于我</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/myblog/" class="nav-link">首页</a></div><div class="nav-item"><a href="/myblog/mysql/" class="nav-link router-link-active">MySQL</a></div><div class="nav-item"><a href="/myblog/" class="nav-link">#####</a></div><div class="nav-item"><a href="/myblog/" class="nav-link">#####</a></div><div class="nav-item"><a href="/myblog/about/" class="nav-link">关于我</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>MySQL学习笔记</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/myblog/mysql/mysql00.html" class="sidebar-link">初始化安装：</a></li><li><a href="/myblog/mysql/mysql01.html" class="sidebar-link">MySQL安装、初始化、启停操作、添加用户、权限管理</a></li><li><a href="/myblog/mysql/mysql02.html" class="sidebar-link">MySQL主从复制配置（异步）</a></li><li><a href="/myblog/mysql/mysql03.html" class="sidebar-link">MySQL同步复制配置</a></li><li><a href="/myblog/mysql/mysql04.html" class="sidebar-link">Mysql 备份操作</a></li><li><a href="/myblog/mysql/mysql04-01.html" class="active sidebar-link">xtraback备份与恢复</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/myblog/mysql/mysql05.html" class="sidebar-link">MySQL5.7升级</a></li><li><a href="/myblog/mysql/mysql06.html" class="sidebar-link">percona-toolkit工具包安装使用</a></li><li><a href="/myblog/mysql/mysql07.html" class="sidebar-link">MySQL慢日志监控配置</a></li><li><a href="/myblog/mysql/mysql08.html" class="sidebar-link">对慢查询日志进行分析</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h3 id="xtraback备份与恢复"><a href="#xtraback备份与恢复" aria-hidden="true" class="header-anchor">#</a> xtraback备份与恢复</h3> <h4 id="_1-准备工作"><a href="#_1-准备工作" aria-hidden="true" class="header-anchor">#</a> 1. 准备工作</h4> <ul><li><p>先安装percona-xtrabackup
下载官网：https://www.percona.com/downloads/XtraBackup/LATEST/</p></li> <li><p>下载好之后传到服务器上，然后解压
解包：tar -zxvf FileName.tar</p></li> <li><p>修改配置文件----根目录下面的 .bash_profile文件</p> <p>vi .bash_profile</p></li> <li><p>添加配置export PATH=$PATH:/paas/iddbs/liuli/mysql01/percona-xtrabackup-2.4.7-Linux-x86_64/bin</p> <p>注意：添加的路径是解压后的percona-xtrabackup下面的bin目录所在的路径，用pwd就可以显示</p> <p>然后在任意路径下，刷新配置文件 source ~/.bash_profile</p> <p>刷新之后使用命令 innobackupex --help 来查看是否配置成功</p></li></ul> <h4 id="_2-xtrabackup选项"><a href="#_2-xtrabackup选项" aria-hidden="true" class="header-anchor">#</a> 2. xtrabackup选项</h4> <h5 id="_1）参数选项"><a href="#_1）参数选项" aria-hidden="true" class="header-anchor">#</a> 1）参数选项</h5> <p><em>参数说明：</em></p> <ul><li>--default-file=[my.cnf] 指定配置文件</li> <li>--databases=#    //指定备份的数据库和表，格式为：--databases=&quot;db1[.tb1] db2[.tb2]&quot; 多个库之间以空格隔开，如果此选项不被指定，将会备份所有的数据库。</li> <li>--use-menory=# 此选项接受一个字符参数（1M/1MB,1G/1GB，默认100M），仅与--apply-log一起使用，该选项指定prepare时用于崩溃恢复（crash-recovery）的内存。</li> <li>--apply-log  //应用 BACKUP-DIR 中的 xtrabackup_logfile 事务日志文件。一般情况下，在备份完成后，数据尚且不能用于恢复操作，因为备份的数据中可能会包含尚未提交的事务或已经提交但尚未同步至数据文件中的事务。因此，此时数据文件仍处于不一致状态。“准备”的主要作用正是通过回滚未提交的事务及同步已经提交的事务至数据文件使得数据文件处于一致性状态</li> <li>--copy-back  //拷贝先前备份所有文件到它们的原始路径。但原路径下不能有任何文件或目录，除非指定 --force-non-empty-directories 选项</li> <li>--force-non-empty-directories    //恢复时指定此选项，可使 --copy-back 和 --move-back 复制文件到非空目录，即原data目录下可以有其他文件，但是不能有与恢复文件中同名的文件，否则恢复失败。</li></ul> <h4 id="_3-全量备份恢复操作"><a href="#_3-全量备份恢复操作" aria-hidden="true" class="header-anchor">#</a> 3. 全量备份恢复操作</h4> <h5 id="_1）完全备份"><a href="#_1）完全备份" aria-hidden="true" class="header-anchor">#</a> 1）完全备份</h5> <p>​	<strong>创建用于备份恢复的用户pxb并赋给权限</strong></p> <div class="language- extra-class"><pre class="language-text"><code>mysql&gt; create user pxb@'localhost' identified by '123456';
mysql&gt; grant reload,process,lock tables,replication client on *.* to pxb@'localhost';
mysql&gt; flush privileges;

</code></pre></div><p>​		<strong>创建存放目录</strong></p> <div class="language- extra-class"><pre class="language-text"><code>[root@centos6 mysql]# mkdir -pv /data/pxb
mkdir: 已创建目录 &quot;/data&quot;
mkdir: 已创建目录 &quot;/data/pxb&quot;
</code></pre></div><p>​		<strong>进行数据库全备</strong></p> <div class="language- extra-class"><pre class="language-text"><code>innobackupex --defaults-file=/paas/iddbs/liuli/mysql01/mysql/etc/my21000.cnf --socket=/paas/iddbs/liuli/mysql01/mysql/21000/mysql.sock --user=pxb -p1234 /paas/iddbs/liuli/mysql01/mysql/data/pxb
</code></pre></div><p><img src="/ph/1570851914008.png" alt="1570851914008"></p> <p><img src="/ph/1570851943560.png" alt="1570851943560"></p> <p><strong>可以看到整个备份过程：连接数据库，开始拷贝redo log，拷贝innodb表文件，锁表、拷贝非innodb表文件，停止拷贝redo log，解锁。</strong></p> <p><strong>上面执行的备份语句会将mysql数据文件（即由my21000.cnf里的变量datadir指定的）拷贝至备份目录下（/paas/iddbs/liuli/mysql01/mysql/data/pxb)</strong></p> <p>​		<strong>查看生成的文件：</strong></p> <p><img src="/ph/1570852033686.png" alt="1570852033686"></p> <p>​	<strong>其中，mysql/， performance_schema/， sys/ ，test/ ，test1/ 下存放的是数据库文件。</strong></p> <p>​		<strong>backup-my.cnf，备份命令用到的配置选项信息；</strong></p> <div class="language- extra-class"><pre class="language-text"><code>[iddbs@host-172-18-231-117 pxb]$ cat 2019-10-12_11-44-11/backup-my.cnf
# This MySQL options file was generated by innobackupex.

# The MySQL server
[mysqld]
innodb_checksum_algorithm=crc32
innodb_log_checksum_algorithm=strict_crc32
innodb_data_file_path=ibdata1:12M:autoextend
innodb_log_files_in_group=2
innodb_log_file_size=50331648
innodb_fast_checksum=false
innodb_page_size=16384
innodb_log_block_size=512
innodb_undo_directory=./
innodb_undo_tablespaces=0
server_id=11721000

redo_log_version=1

</code></pre></div><p>​		<strong>xtrabackup_binlog_info，mysql服务器当前正在使用的二进制日志文件及至备份这一刻为止二进制日志事件的位置；</strong></p> <div class="language- extra-class"><pre class="language-text"><code>[iddbs@host-172-18-231-117 2019-10-12_11-44-11]$ cat xtrabackup_binlog_info
mysql-bin.000006        847
</code></pre></div><p>​	<strong>xtrabackup_checkpoints，备份类型（如完全或增量）、备份状态（如是否已经为prepared状态）和LSN(日志序列号)范围信息；</strong></p> <div class="language- extra-class"><pre class="language-text"><code>[iddbs@host-172-18-231-117 2019-10-12_11-44-11]$ cat xtrabackup_checkpoints
backup_type = full-backuped
from_lsn = 0
to_lsn = 2637328
last_lsn = 2637337
compact = 0
recover_binlog_info = 0

</code></pre></div><p>​		<strong>xtrabackup_info，记录备份的基本信息，uuid、备份命令、备份时间、binlog、LSN、以及其他加密压缩等信息。</strong></p> <div class="language- extra-class"><pre class="language-text"><code> filename 'mysql-bin.000006', position '847', GTID of the last change '1c2aa144-eb20-11e9-8228-fa163e69bc22:1-17,
4f4a22a3-e00d-11e9-ae53-fa163e69bc22:1-13,
bdfc2656-e00d-11e9-8fe5-fa163e69bc22:1-4'
innodb_from_lsn = 0
innodb_to_lsn = 2637328
partial = N
incremental = N
format = file
compact = N
</code></pre></div><h5 id="_2-全量恢复"><a href="#_2-全量恢复" aria-hidden="true" class="header-anchor">#</a> 2) 全量恢复</h5> <p>​	 <strong>关闭数据库并删除数据文件</strong></p> <div class="language- extra-class"><pre class="language-text"><code>[iddbs@host-172-18-231-117 mysql]$ ./bin/mysqladmin -uroot -proot -h127.0.0.1 -P21000 shutdown
[iddbs@host-172-18-231-117 mysql]$ mv 21000 21000_10_12
[iddbs@host-172-18-231-117 mysql]$ mkdir 21000
</code></pre></div><p>​	<strong>准备(prepare)一个完全备份：--apply-log ( //paas/iddbs/liuli/mysql01/mysql/data/pxb/2019-10-12_11-44-11/ 为备份目录，执行之后 xtrabackup_checkpoints 文件中的 backup_type = full-prepared )</strong></p> <div class="language- extra-class"><pre class="language-text"><code>[iddbs@host-172-18-231-117 mysql]$ innobackupex --apply-log data/pxb/2019-10-12_11-44-11/
</code></pre></div><p><img src="/ph/1570859340143.png" alt="1570859340143"></p> <p><img src="/ph/1570859357157.png" alt="1570859357157"></p> <ul><li>执行恢复操作</li></ul> <div class="language- extra-class"><pre class="language-text"><code>[iddbs@host-172-18-231-117 mysql]$ innobackupex --defaults-file=etc/my21000.cnf --copy-back --rsync ./data/pxb/2019-10-12_11-44-11/
</code></pre></div><p><img src="/ph/1570859631878.png" alt="1570859631878"></p> <p><img src="/ph/1570859604741.png" alt="1570859604741"></p> <p>​		<strong>启动mysql、查看数据库恢复情况</strong></p> <div class="language- extra-class"><pre class="language-text"><code>[iddbs@host-172-18-231-117 mysql]$ ./bin/mysqld_safe --defaults-file=/paas/iddbs/liuli/mysql01/mysql/etc/my21000.cnf &amp;
[iddbs@host-172-18-231-117 mysql]$ ./bin/mysql -uroot -proot -h127.0.0.1 -P21000
mysql&gt; show databases;
</code></pre></div><p><img src="/ph/1570860082067.png" alt="1570860082067"></p> <h4 id="_4-增量备份恢复操作"><a href="#_4-增量备份恢复操作" aria-hidden="true" class="header-anchor">#</a> 4. 增量备份恢复操作</h4> <p><em><strong>使用xtraback进行增量备份只是针对innoDB这类支持事务的引擎，对于MyISAM等引擎，仍然使用全量备份</strong></em></p> <p><em>我们以之前做的全备为基准，在其基础上做增量备份：</em></p> <p>​	<strong>新建一张表并插入数据作为增量</strong></p> <div class="language- extra-class"><pre class="language-text"><code>mysql&gt; create table tb1 (id int, name varchar(40));
mysql&gt; insert into tb1 values (1,'aaa'),(2,'bbb'),(3,'ccc'),(26,'zzz');

mysql&gt; select * from tb2;

+------+------+
| id   | name |
+------+------+
|    1 | aaa  |
|    2 | bbb  |
|    3 | ccc  |
|   26 | zzz  |
+------+------+
</code></pre></div><p>​		<strong>增量备份1：（以全备为基准：data/pxb/2019-10-12_11-44-11/）</strong></p> <div class="language- extra-class"><pre class="language-text"><code>innobackupex --defaults-file=/paas/iddbs/liuli/mysql01/mysql/etc/my21000.cnf --user=pxb --password=1234 --socket=/paas/iddbs/liuli/mysql01/mysql/21000/mysql.sock --incremental /paas/iddbs/liuli/mysql01/mysql/data/pxb/inc --incremental-basedir=/paas/iddbs/liuli/mysql01/mysql/data/pxb/2019-10-12_11-44-11/ --parallel=2

[iddbs@host-172-18-231-117 inc]$ cat 2019-10-12_14-25-12/xtrabackup_checkpoints
</code></pre></div><p><img src="/ph/1570861556460.png" alt="1570861556460"></p> <p><img src="/ph/1570861578292.png" alt="1570861578292"></p> <p><img src="/ph/1570861677621.png" alt="1570861677621"></p> <p>​		<strong>再往 tb2 里插入数据：</strong></p> <div class="language- extra-class"><pre class="language-text"><code>mysql&gt; insert into tb1 values (201,'aaa'),(202,'bbb'),(203,'ccc'),(326,'zzz');
Query OK, 4 rows affected (1.02 sec)
Records: 4  Duplicates: 0  Warnings: 0

mysql&gt;  select * from tb2;
+------+------+
| id   | name |
+------+------+
|    1 | aaa  |
|    2 | bbb  |
|    3 | ccc  |
|   26 | zzz  |
|  201 | aaa  |
|  202 | bbb  |
|  203 | ccc  |
|  326 | zzz  |
+------+------+
8 rows in set (0.00 sec)

</code></pre></div><p>​		<strong>增量备份2：（ 以增量1为基准：/data/pxb/inc/2019-10-12_15-04-18/ ）</strong></p> <div class="language- extra-class"><pre class="language-text"><code>innobackupex --defaults-file=/paas/iddbs/liuli/mysql01/mysql/etc/my21000.cnf --user=pxb --password=1234 --socket=/paas/iddbs/liuli/mysql01/mysql/21000/mysql.sock --incremental /paas/iddbs/liuli/mysql01/mysql/data/pxb/inc --incremental-basedir=/paas/iddbs/liuli/mysql01/mysql/data/pxb/inc/2019-10-12_15-04-18/ --parallel=2
</code></pre></div><p><em><strong>增量恢复操作</strong></em></p> <p><em>增量备份的恢复需要有3个步骤</em></p> <ol><li><em>恢复完全备份</em></li> <li><em>恢复增量备份到完全备份(开始恢复的增量备份要添加--redo-only参数，到最后一次增量备份要去掉--redo-only)</em></li> <li><em>对整体的完全备份进行恢复，回滚未提交的数据</em></li></ol> <div class="language- extra-class"><pre class="language-text"><code> ##准备一个全备##
[iddbs@host-172-18-231-117 pxb] innobackupex --apply-log --redo-only /paas/iddbs/liuli/mysql01/mysql/data/pxb/2019-10-12_11-44-11/
xtrabackup: starting shutdown with innodb_fast_shutdown = 1
InnoDB: Starting shutdown...
InnoDB: Shutdown completed; log sequence number 2637873
InnoDB: Number of pools: 1
191012 14:41:30 completed OK!

 ##将增量1应用到完全备份##
[iddbs@host-172-18-231-117 pxb] innobackupex --apply-log --redo-only /paas/iddbs/liuli/mysql01/mysql/data/pxb/2019-10-12_11-44-11 --incremental-dir=/paas/iddbs/liuli/mysql01/mysql/data/pxb/inc/2019-10-12_15-04-18

 ##将增量2应用到完全备份，注意不加 --redo-only 参数了##
[iddbs@host-172-18-231-117 pxb] innobackupex --apply-log /paas/iddbs/liuli/mysql01/mysql/data/pxb/2019-10-12_11-44-11 --incremental-dir=/paas/iddbs/liuli/mysql01/mysql/data/pxb/inc/2019-10-12_15-05-35

 ##把所有合在一起的完全备份整体进行一次apply操作，回滚未提交的数据##
[iddbs@host-172-18-231-117 pxb] innobackupex --apply-log /paas/iddbs/liuli/mysql01/mysql/data/pxb/2019-10-12_11-44-11/
</code></pre></div><p>​		<strong>全量恢复</strong></p> <div class="language- extra-class"><pre class="language-text"><code>innobackupex --defaults-file=/paas/iddbs/liuli/mysql01/mysql/etc/21000my.cnf --copy-back --rsync /paas/iddbs/liuli/mysql01/mysql/data/pxb/2019-10-12_11-44-11/

</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/myblog/mysql/mysql04.html" class="prev">
          Mysql 备份操作
        </a></span> <span class="next"><a href="/myblog/mysql/mysql05.html">
          MySQL5.7升级
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/myblog/assets/js/app.d89ba8c6.js" defer></script><script src="/myblog/assets/js/2.4d65e3a3.js" defer></script><script src="/myblog/assets/js/16.4cb3a0bf.js" defer></script>
  </body>
</html>
