<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Mysql 备份操作 | 个人博客</title>
    <meta name="description" content="liulidu">
    <link rel="icon" href="/myblog/image/logo.png">
    
    <link rel="preload" href="/myblog/assets/css/0.styles.c5a6e6d2.css" as="style"><link rel="preload" href="/myblog/assets/js/app.d89ba8c6.js" as="script"><link rel="preload" href="/myblog/assets/js/2.4d65e3a3.js" as="script"><link rel="preload" href="/myblog/assets/js/17.b6bab035.js" as="script"><link rel="prefetch" href="/myblog/assets/js/10.92fdb281.js"><link rel="prefetch" href="/myblog/assets/js/11.1e78a99e.js"><link rel="prefetch" href="/myblog/assets/js/12.03774e1d.js"><link rel="prefetch" href="/myblog/assets/js/13.aaa2525d.js"><link rel="prefetch" href="/myblog/assets/js/14.a9bf3e64.js"><link rel="prefetch" href="/myblog/assets/js/15.070b174f.js"><link rel="prefetch" href="/myblog/assets/js/16.4cb3a0bf.js"><link rel="prefetch" href="/myblog/assets/js/18.be402a1a.js"><link rel="prefetch" href="/myblog/assets/js/19.745e56d6.js"><link rel="prefetch" href="/myblog/assets/js/20.ded294f0.js"><link rel="prefetch" href="/myblog/assets/js/21.4536d46d.js"><link rel="prefetch" href="/myblog/assets/js/22.37f6eaa0.js"><link rel="prefetch" href="/myblog/assets/js/3.870fcab9.js"><link rel="prefetch" href="/myblog/assets/js/4.0615d0ae.js"><link rel="prefetch" href="/myblog/assets/js/5.db2919ce.js"><link rel="prefetch" href="/myblog/assets/js/6.18cce36a.js"><link rel="prefetch" href="/myblog/assets/js/7.161a12b9.js"><link rel="prefetch" href="/myblog/assets/js/8.fdf184c2.js"><link rel="prefetch" href="/myblog/assets/js/9.305d2036.js">
    <link rel="stylesheet" href="/myblog/assets/css/0.styles.c5a6e6d2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/myblog/" class="home-link router-link-active"><!----> <span class="site-name">个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/myblog/" class="nav-link">首页</a></div><div class="nav-item"><a href="/myblog/mysql/" class="nav-link router-link-active">MySQL</a></div><div class="nav-item"><a href="/myblog/" class="nav-link">#####</a></div><div class="nav-item"><a href="/myblog/" class="nav-link">#####</a></div><div class="nav-item"><a href="/myblog/about/" class="nav-link">关于我</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/myblog/" class="nav-link">首页</a></div><div class="nav-item"><a href="/myblog/mysql/" class="nav-link router-link-active">MySQL</a></div><div class="nav-item"><a href="/myblog/" class="nav-link">#####</a></div><div class="nav-item"><a href="/myblog/" class="nav-link">#####</a></div><div class="nav-item"><a href="/myblog/about/" class="nav-link">关于我</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>MySQL学习笔记</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/myblog/mysql/mysql00.html" class="sidebar-link">初始化安装：</a></li><li><a href="/myblog/mysql/mysql01.html" class="sidebar-link">MySQL安装、初始化、启停操作、添加用户、权限管理</a></li><li><a href="/myblog/mysql/mysql02.html" class="sidebar-link">MySQL主从复制配置（异步）</a></li><li><a href="/myblog/mysql/mysql03.html" class="sidebar-link">MySQL同步复制配置</a></li><li><a href="/myblog/mysql/mysql04.html" class="active sidebar-link">Mysql 备份操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myblog/mysql/mysql04.html#备份导出" class="sidebar-link">备份导出</a></li></ul></li><li><a href="/myblog/mysql/mysql04-01.html" class="sidebar-link">xtraback备份与恢复</a></li><li><a href="/myblog/mysql/mysql05.html" class="sidebar-link">MySQL5.7升级</a></li><li><a href="/myblog/mysql/mysql06.html" class="sidebar-link">percona-toolkit工具包安装使用</a></li><li><a href="/myblog/mysql/mysql07.html" class="sidebar-link">MySQL慢日志监控配置</a></li><li><a href="/myblog/mysql/mysql08.html" class="sidebar-link">对慢查询日志进行分析</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h4 id="mysql-备份操作"><a href="#mysql-备份操作" aria-hidden="true" class="header-anchor">#</a> Mysql 备份操作</h4> <h5 id="_1-使用cp命令进行备份"><a href="#_1-使用cp命令进行备份" aria-hidden="true" class="header-anchor">#</a> 1 使用cp命令进行备份</h5> <div class="language- extra-class"><pre class="language-text"><code>mkdir backup ---&gt; cp -a ./mysql/21000/* ./mysql/backup/ 
参数：-a 保持源文件结构进行复制
</code></pre></div><h5 id="_2-使用dump备份"><a href="#_2-使用dump备份" aria-hidden="true" class="header-anchor">#</a> 2 使用dump备份</h5> <p>适用于所有存储引擎，支持温备份，完全备份，部分备份，对InnoDB支持热备，先使用mysqldump度数据进行
完全备份，然后定期备份binary log达到增量备份、恢复，可以备份单库、单表、表结构等</p> <div class="language- extra-class"><pre class="language-text"><code>mysqldump [argument] &gt; file_name
</code></pre></div><hr> <h2 id="备份导出"><a href="#备份导出" aria-hidden="true" class="header-anchor">#</a> 备份导出</h2> <h6 id="_2-1-导出全部数据库表"><a href="#_2-1-导出全部数据库表" aria-hidden="true" class="header-anchor">#</a> 2.1 导出全部数据库表</h6> <div class="language- extra-class"><pre class="language-text"><code>mysqldump --socket-file=/paas/iddbs/liuli/mysql01/mysql/21000/mysql.sock -umysql -pmysql --all-databases &gt; /paas/iddbs/liuli/mysql01/mysql/21000dump/21000all.sql
mysqldump -h127.0.0.1 -P21000 -uroot -proot --all-databases &gt; /paas/iddbs/liuli/mysql01/mysql/21000dump/21000all.sql
&lt;如果对添加的用户设置权限，则导出全部数据库表会出现权限不足&gt;
</code></pre></div><h6 id="_2-2-导出部分数据库表"><a href="#_2-2-导出部分数据库表" aria-hidden="true" class="header-anchor">#</a> 2.2 导出部分数据库表</h6> <div class="language- extra-class"><pre class="language-text"><code>mysqldump --socket-file=/paas/iddbs/liuli/mysql01/mysql/21000/mysql.sock -umysql -pmysql -databases test xxx.db &gt; /paas/iddbs/liuli/mysql01/mysql/21000dump/21000all.sql
mysqldump -h127.0.0.1 -P21000 -uroot -proot -databases test xxx.db &gt; /paas/iddbs/liuli/mysql01/mysql/21000dump/21000part.sql
</code></pre></div><h6 id="_2-3-导出单个数据库"><a href="#_2-3-导出单个数据库" aria-hidden="true" class="header-anchor">#</a> 2.3 导出单个数据库</h6> <p><strong>2.3.1 方法1</strong></p> <div class="language- extra-class"><pre class="language-text"><code>mysqldump --socket-file=/paas/iddbs/liuli/mysql01/mysql/21000/mysql.sock -umysql -pmysql --databases test &gt; /paas/iddbs/liuli/mysql01/mysql/21000dump/21000all.sql
mysqldump -h127.0.0.1 -P21000 -uroot -proot --databases test &gt; /paas/iddbs/liuli/mysql01/mysql/21000dump/21000partdata.sql
</code></pre></div><p><strong>2.3.2 方法2</strong></p> <div class="language- extra-class"><pre class="language-text"><code>mysqldump --socket-file=/paas/iddbs/liuli/mysql01/mysql/21000/mysql.sock -umysql -pmysql --databases test &gt; /paas/iddbs/liuli/mysql01/mysql/21000dump/21000all.sql
mysqldump -h127.0.0.1 -P21000 -uroot -proot test &gt; /paas/iddbs/liuli/mysql01/mysql/21000dump/21000partnodata.sql
</code></pre></div><p>区别：
--databases在导出数据时会加上CREATE DATABASE 或 USE 语句，
不使用--databases参数在导入数据时需要先指定一个存在的数据库作为默认数据库导入数据。</p> <h6 id="_2-4导出数据库结构（不含数据）"><a href="#_2-4导出数据库结构（不含数据）" aria-hidden="true" class="header-anchor">#</a> 2.4导出数据库结构（不含数据）</h6> <div class="language- extra-class"><pre class="language-text"><code>mysqldump -u root -proot -h127.0.0.1 -P21000 -d test &gt; /paas/iddbs/liuli/mysql01/mysql/21000dump/test.sql
</code></pre></div><h6 id="_2-5-导出指定数据库表"><a href="#_2-5-导出指定数据库表" aria-hidden="true" class="header-anchor">#</a> 2.5 导出指定数据库表</h6> <div class="language- extra-class"><pre class="language-text"><code>mysqldump -h127.0.0.1 -P21000 -u root -proot test test01 &gt; ./21000dump/test01.sql
</code></pre></div><p>导入SQL格式文件
​		新建一个库</p> <div class="language- extra-class"><pre class="language-text"><code>mysql&gt; source /paas/iddbs/liuli/mysql01/mysql/21000dump/test.sql 
</code></pre></div><p>​		错误：</p> <div class="language- extra-class"><pre class="language-text"><code>@@GLOBAL.GTID_PURGED can only be set when @@GLOBAL.GTID_EXECUTED is empty.
</code></pre></div><p>原因：在导出的库开启了GTID半同步复制，所以GTID_EXECUTED 的值不为空
​解决：
​reset mater 置空操作
​在进行导出时加上--set-gtid-purged=off</p> <h4 id="使用xtraback备份和恢复"><a href="#使用xtraback备份和恢复" aria-hidden="true" class="header-anchor">#</a> 使用xtraback备份和恢复</h4> <h5 id="_1）、准备工作"><a href="#_1）、准备工作" aria-hidden="true" class="header-anchor">#</a> 1）、准备工作</h5> <p>先安装percona-xtrabackup
下载官网：https://www.percona.com/downloads/XtraBackup/LATEST/</p> <p>下载好之后传到服务器上，然后解压
解包：tar -zxvf FileName.tar</p> <p>修改配置文件----根目录下面的 .bash_profile文件</p> <p>vi .bash_profile</p> <p>添加配置export PATH=$PATH:/paas/iddbs/liuli/mysql01/percona-xtrabackup-2.4.7-Linux-x86_64/bin</p> <p>注意：添加的路径是解压后的percona-xtrabackup下面的bin目录所在的路径，用pwd就可以显示</p> <p>然后在任意路径下，刷新配置文件 source ~/.bash_profile</p> <p>刷新之后使用命令 innobackupex --help 来查看是否配置成功</p> <h5 id="_2）全量备份操作"><a href="#_2）全量备份操作" aria-hidden="true" class="header-anchor">#</a> 2）全量备份操作</h5> <p>执行下面语句进行全备：</p> <div class="language- extra-class"><pre class="language-text"><code>innobackupex --defaults-file=/paas/iddbs/liuli/mysql01/mysql/etc/my21000.cnf --socket=/paas/iddbs/liuli/mysql01/mysql/21000/mysql.sock --user=root -proot /paas/iddbs/liuli/mysql01/mysql/21000xtra
</code></pre></div><p>190510 14:51:53 completed OK!<br> <img src="/ph/1570515772111.png" alt="1570515772111">
出现上述语句代表备份成功</p> <p>上面执行的备份语句会将mysql数据文件（即由my21000.cnf里的变量datadir指定的）拷贝至备份目录下（/paas/iddbs/liuli/mysql01/mysql/21000xtra)</p> <h4 id="全量备份后的恢复操作"><a href="#全量备份后的恢复操作" aria-hidden="true" class="header-anchor">#</a> 全量备份后的恢复操作</h4> <p>注意：恢复之前
1）要先关闭数据库
2）要删除数据文件和日志文件（也可以mv移到别的地方，只要确保清空mysql数据存放目录就行） 清空data</p> <div class="language- extra-class"><pre class="language-text"><code>innobackupex --defaults-file=/paas/iddbs/liuli/mysql01/mysql/etc/21000.cnf --user=root -proot --use-memory=1G --apply-log /paas/iddbs/liuli/mysql01/mysql/21000xtra/2019-10-08_14-21-27/  
innobackupex --defaults-file=/paas/iddbs/liuli/mysql01/mysql/etc/21000.cnf --uroot -proot --copy-back /paas/iddbs/liuli/mysql01/mysql/21000xtra/2019-10-08_14-21-27/

</code></pre></div><p><em>参数说明：</em></p> <p>--default-file=[my.cnf] 指定配置文件</p> <p>--use-menory=# 此选项接受一个字符参数（1M/1MB,1G/1GB，默认100M），仅与--apply-log一起使用，该选项指定prepare时用于崩溃恢复（crash-recovery）的内存。</p> <p>--apply-log  //应用 BACKUP-DIR 中的 xtrabackup_logfile 事务日志文件。一般情况下，在备份完成后，数据尚且不能用于恢复操作，因为备份的数据中可能会包含尚未提交的事务或已经提交但尚未同步至数据文件中的事务。因此，此时数据文件仍处于不一致状态。“准备”的主要作用正是通过回滚未提交的事务及同步已经提交的事务至数据文件使得数据文件处于一致性状态</p> <p>--copy-back  //拷贝先前备份所有文件到它们的原始路径。但原路径下不能有任何文件或目录，除非指定 --force-non-empty-directories 选项</p> <p>--force-non-empty-directories    //恢复时指定此选项，可使 --copy-back 和 --move-back 复制文件到非空目录，即原data目录下可以有其他文件，但是不能有与恢复文件中同名的文件，否则恢复失败。</p> <p>170404 14:24:07  innobackupex: completed OK!</p> <p><img src="/ph/1570517099296.png" alt="1570517099296"></p> <p>出现上面的信息，说明数据恢复成功了</p> <p><strong>可参考博客</strong>：https://www.cnblogs.com/waynechou/p/xtrabackup_backup.html</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/myblog/mysql/mysql03.html" class="prev">
          MySQL同步复制配置
        </a></span> <span class="next"><a href="/myblog/mysql/mysql04-01.html">
          xtraback备份与恢复
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/myblog/assets/js/app.d89ba8c6.js" defer></script><script src="/myblog/assets/js/2.4d65e3a3.js" defer></script><script src="/myblog/assets/js/17.b6bab035.js" defer></script>
  </body>
</html>
