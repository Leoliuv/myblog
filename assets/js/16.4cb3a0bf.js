(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{204:function(a,s,t){"use strict";t.r(s);var e=t(0),n=Object(e.a)({},function(){var a=this,s=a.$createElement,t=a._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h3",{attrs:{id:"xtraback备份与恢复"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#xtraback备份与恢复","aria-hidden":"true"}},[a._v("#")]),a._v(" xtraback备份与恢复")]),a._v(" "),t("h4",{attrs:{id:"_1-准备工作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-准备工作","aria-hidden":"true"}},[a._v("#")]),a._v(" 1. 准备工作")]),a._v(" "),t("ul",[t("li",[t("p",[a._v("先安装percona-xtrabackup\n下载官网：https://www.percona.com/downloads/XtraBackup/LATEST/")])]),a._v(" "),t("li",[t("p",[a._v("下载好之后传到服务器上，然后解压\n解包：tar -zxvf FileName.tar")])]),a._v(" "),t("li",[t("p",[a._v("修改配置文件----根目录下面的 .bash_profile文件")]),a._v(" "),t("p",[a._v("vi .bash_profile")])]),a._v(" "),t("li",[t("p",[a._v("添加配置export PATH=$PATH:/paas/iddbs/liuli/mysql01/percona-xtrabackup-2.4.7-Linux-x86_64/bin")]),a._v(" "),t("p",[a._v("注意：添加的路径是解压后的percona-xtrabackup下面的bin目录所在的路径，用pwd就可以显示")]),a._v(" "),t("p",[a._v("然后在任意路径下，刷新配置文件 source ~/.bash_profile")]),a._v(" "),t("p",[a._v("刷新之后使用命令 innobackupex --help 来查看是否配置成功")])])]),a._v(" "),t("h4",{attrs:{id:"_2-xtrabackup选项"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-xtrabackup选项","aria-hidden":"true"}},[a._v("#")]),a._v(" 2. xtrabackup选项")]),a._v(" "),t("h5",{attrs:{id:"_1）参数选项"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1）参数选项","aria-hidden":"true"}},[a._v("#")]),a._v(" 1）参数选项")]),a._v(" "),t("p",[t("em",[a._v("参数说明：")])]),a._v(" "),t("ul",[t("li",[a._v("--default-file=[my.cnf] 指定配置文件")]),a._v(" "),t("li",[a._v('--databases=#    //指定备份的数据库和表，格式为：--databases="db1[.tb1] db2[.tb2]" 多个库之间以空格隔开，如果此选项不被指定，将会备份所有的数据库。')]),a._v(" "),t("li",[a._v("--use-menory=# 此选项接受一个字符参数（1M/1MB,1G/1GB，默认100M），仅与--apply-log一起使用，该选项指定prepare时用于崩溃恢复（crash-recovery）的内存。")]),a._v(" "),t("li",[a._v("--apply-log  //应用 BACKUP-DIR 中的 xtrabackup_logfile 事务日志文件。一般情况下，在备份完成后，数据尚且不能用于恢复操作，因为备份的数据中可能会包含尚未提交的事务或已经提交但尚未同步至数据文件中的事务。因此，此时数据文件仍处于不一致状态。“准备”的主要作用正是通过回滚未提交的事务及同步已经提交的事务至数据文件使得数据文件处于一致性状态")]),a._v(" "),t("li",[a._v("--copy-back  //拷贝先前备份所有文件到它们的原始路径。但原路径下不能有任何文件或目录，除非指定 --force-non-empty-directories 选项")]),a._v(" "),t("li",[a._v("--force-non-empty-directories    //恢复时指定此选项，可使 --copy-back 和 --move-back 复制文件到非空目录，即原data目录下可以有其他文件，但是不能有与恢复文件中同名的文件，否则恢复失败。")])]),a._v(" "),t("h4",{attrs:{id:"_3-全量备份恢复操作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-全量备份恢复操作","aria-hidden":"true"}},[a._v("#")]),a._v(" 3. 全量备份恢复操作")]),a._v(" "),t("h5",{attrs:{id:"_1）完全备份"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1）完全备份","aria-hidden":"true"}},[a._v("#")]),a._v(" 1）完全备份")]),a._v(" "),t("p",[a._v("​\t"),t("strong",[a._v("创建用于备份恢复的用户pxb并赋给权限")])]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("mysql> create user pxb@'localhost' identified by '123456';\nmysql> grant reload,process,lock tables,replication client on *.* to pxb@'localhost';\nmysql> flush privileges;\n\n")])])]),t("p",[a._v("​\t\t"),t("strong",[a._v("创建存放目录")])]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v('[root@centos6 mysql]# mkdir -pv /data/pxb\nmkdir: 已创建目录 "/data"\nmkdir: 已创建目录 "/data/pxb"\n')])])]),t("p",[a._v("​\t\t"),t("strong",[a._v("进行数据库全备")])]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("innobackupex --defaults-file=/paas/iddbs/liuli/mysql01/mysql/etc/my21000.cnf --socket=/paas/iddbs/liuli/mysql01/mysql/21000/mysql.sock --user=pxb -p1234 /paas/iddbs/liuli/mysql01/mysql/data/pxb\n")])])]),t("p",[t("img",{attrs:{src:"/ph/1570851914008.png",alt:"1570851914008"}})]),a._v(" "),t("p",[t("img",{attrs:{src:"/ph/1570851943560.png",alt:"1570851943560"}})]),a._v(" "),t("p",[t("strong",[a._v("可以看到整个备份过程：连接数据库，开始拷贝redo log，拷贝innodb表文件，锁表、拷贝非innodb表文件，停止拷贝redo log，解锁。")])]),a._v(" "),t("p",[t("strong",[a._v("上面执行的备份语句会将mysql数据文件（即由my21000.cnf里的变量datadir指定的）拷贝至备份目录下（/paas/iddbs/liuli/mysql01/mysql/data/pxb)")])]),a._v(" "),t("p",[a._v("​\t\t"),t("strong",[a._v("查看生成的文件：")])]),a._v(" "),t("p",[t("img",{attrs:{src:"/ph/1570852033686.png",alt:"1570852033686"}})]),a._v(" "),t("p",[a._v("​\t"),t("strong",[a._v("其中，mysql/， performance_schema/， sys/ ，test/ ，test1/ 下存放的是数据库文件。")])]),a._v(" "),t("p",[a._v("​\t\t"),t("strong",[a._v("backup-my.cnf，备份命令用到的配置选项信息；")])]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("[iddbs@host-172-18-231-117 pxb]$ cat 2019-10-12_11-44-11/backup-my.cnf\n# This MySQL options file was generated by innobackupex.\n\n# The MySQL server\n[mysqld]\ninnodb_checksum_algorithm=crc32\ninnodb_log_checksum_algorithm=strict_crc32\ninnodb_data_file_path=ibdata1:12M:autoextend\ninnodb_log_files_in_group=2\ninnodb_log_file_size=50331648\ninnodb_fast_checksum=false\ninnodb_page_size=16384\ninnodb_log_block_size=512\ninnodb_undo_directory=./\ninnodb_undo_tablespaces=0\nserver_id=11721000\n\nredo_log_version=1\n\n")])])]),t("p",[a._v("​\t\t"),t("strong",[a._v("xtrabackup_binlog_info，mysql服务器当前正在使用的二进制日志文件及至备份这一刻为止二进制日志事件的位置；")])]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("[iddbs@host-172-18-231-117 2019-10-12_11-44-11]$ cat xtrabackup_binlog_info\nmysql-bin.000006        847\n")])])]),t("p",[a._v("​\t"),t("strong",[a._v("xtrabackup_checkpoints，备份类型（如完全或增量）、备份状态（如是否已经为prepared状态）和LSN(日志序列号)范围信息；")])]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("[iddbs@host-172-18-231-117 2019-10-12_11-44-11]$ cat xtrabackup_checkpoints\nbackup_type = full-backuped\nfrom_lsn = 0\nto_lsn = 2637328\nlast_lsn = 2637337\ncompact = 0\nrecover_binlog_info = 0\n\n")])])]),t("p",[a._v("​\t\t"),t("strong",[a._v("xtrabackup_info，记录备份的基本信息，uuid、备份命令、备份时间、binlog、LSN、以及其他加密压缩等信息。")])]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v(" filename 'mysql-bin.000006', position '847', GTID of the last change '1c2aa144-eb20-11e9-8228-fa163e69bc22:1-17,\n4f4a22a3-e00d-11e9-ae53-fa163e69bc22:1-13,\nbdfc2656-e00d-11e9-8fe5-fa163e69bc22:1-4'\ninnodb_from_lsn = 0\ninnodb_to_lsn = 2637328\npartial = N\nincremental = N\nformat = file\ncompact = N\n")])])]),t("h5",{attrs:{id:"_2-全量恢复"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-全量恢复","aria-hidden":"true"}},[a._v("#")]),a._v(" 2) 全量恢复")]),a._v(" "),t("p",[a._v("​\t "),t("strong",[a._v("关闭数据库并删除数据文件")])]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("[iddbs@host-172-18-231-117 mysql]$ ./bin/mysqladmin -uroot -proot -h127.0.0.1 -P21000 shutdown\n[iddbs@host-172-18-231-117 mysql]$ mv 21000 21000_10_12\n[iddbs@host-172-18-231-117 mysql]$ mkdir 21000\n")])])]),t("p",[a._v("​\t"),t("strong",[a._v("准备(prepare)一个完全备份：--apply-log ( //paas/iddbs/liuli/mysql01/mysql/data/pxb/2019-10-12_11-44-11/ 为备份目录，执行之后 xtrabackup_checkpoints 文件中的 backup_type = full-prepared )")])]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("[iddbs@host-172-18-231-117 mysql]$ innobackupex --apply-log data/pxb/2019-10-12_11-44-11/\n")])])]),t("p",[t("img",{attrs:{src:"/ph/1570859340143.png",alt:"1570859340143"}})]),a._v(" "),t("p",[t("img",{attrs:{src:"/ph/1570859357157.png",alt:"1570859357157"}})]),a._v(" "),t("ul",[t("li",[a._v("执行恢复操作")])]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("[iddbs@host-172-18-231-117 mysql]$ innobackupex --defaults-file=etc/my21000.cnf --copy-back --rsync ./data/pxb/2019-10-12_11-44-11/\n")])])]),t("p",[t("img",{attrs:{src:"/ph/1570859631878.png",alt:"1570859631878"}})]),a._v(" "),t("p",[t("img",{attrs:{src:"/ph/1570859604741.png",alt:"1570859604741"}})]),a._v(" "),t("p",[a._v("​\t\t"),t("strong",[a._v("启动mysql、查看数据库恢复情况")])]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("[iddbs@host-172-18-231-117 mysql]$ ./bin/mysqld_safe --defaults-file=/paas/iddbs/liuli/mysql01/mysql/etc/my21000.cnf &\n[iddbs@host-172-18-231-117 mysql]$ ./bin/mysql -uroot -proot -h127.0.0.1 -P21000\nmysql> show databases;\n")])])]),t("p",[t("img",{attrs:{src:"/ph/1570860082067.png",alt:"1570860082067"}})]),a._v(" "),t("h4",{attrs:{id:"_4-增量备份恢复操作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-增量备份恢复操作","aria-hidden":"true"}},[a._v("#")]),a._v(" 4. 增量备份恢复操作")]),a._v(" "),t("p",[t("em",[t("strong",[a._v("使用xtraback进行增量备份只是针对innoDB这类支持事务的引擎，对于MyISAM等引擎，仍然使用全量备份")])])]),a._v(" "),t("p",[t("em",[a._v("我们以之前做的全备为基准，在其基础上做增量备份：")])]),a._v(" "),t("p",[a._v("​\t"),t("strong",[a._v("新建一张表并插入数据作为增量")])]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("mysql> create table tb1 (id int, name varchar(40));\nmysql> insert into tb1 values (1,'aaa'),(2,'bbb'),(3,'ccc'),(26,'zzz');\n\nmysql> select * from tb2;\n\n+------+------+\n| id   | name |\n+------+------+\n|    1 | aaa  |\n|    2 | bbb  |\n|    3 | ccc  |\n|   26 | zzz  |\n+------+------+\n")])])]),t("p",[a._v("​\t\t"),t("strong",[a._v("增量备份1：（以全备为基准：data/pxb/2019-10-12_11-44-11/）")])]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("innobackupex --defaults-file=/paas/iddbs/liuli/mysql01/mysql/etc/my21000.cnf --user=pxb --password=1234 --socket=/paas/iddbs/liuli/mysql01/mysql/21000/mysql.sock --incremental /paas/iddbs/liuli/mysql01/mysql/data/pxb/inc --incremental-basedir=/paas/iddbs/liuli/mysql01/mysql/data/pxb/2019-10-12_11-44-11/ --parallel=2\n\n[iddbs@host-172-18-231-117 inc]$ cat 2019-10-12_14-25-12/xtrabackup_checkpoints\n")])])]),t("p",[t("img",{attrs:{src:"/ph/1570861556460.png",alt:"1570861556460"}})]),a._v(" "),t("p",[t("img",{attrs:{src:"/ph/1570861578292.png",alt:"1570861578292"}})]),a._v(" "),t("p",[t("img",{attrs:{src:"/ph/1570861677621.png",alt:"1570861677621"}})]),a._v(" "),t("p",[a._v("​\t\t"),t("strong",[a._v("再往 tb2 里插入数据：")])]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("mysql> insert into tb1 values (201,'aaa'),(202,'bbb'),(203,'ccc'),(326,'zzz');\nQuery OK, 4 rows affected (1.02 sec)\nRecords: 4  Duplicates: 0  Warnings: 0\n\nmysql>  select * from tb2;\n+------+------+\n| id   | name |\n+------+------+\n|    1 | aaa  |\n|    2 | bbb  |\n|    3 | ccc  |\n|   26 | zzz  |\n|  201 | aaa  |\n|  202 | bbb  |\n|  203 | ccc  |\n|  326 | zzz  |\n+------+------+\n8 rows in set (0.00 sec)\n\n")])])]),t("p",[a._v("​\t\t"),t("strong",[a._v("增量备份2：（ 以增量1为基准：/data/pxb/inc/2019-10-12_15-04-18/ ）")])]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("innobackupex --defaults-file=/paas/iddbs/liuli/mysql01/mysql/etc/my21000.cnf --user=pxb --password=1234 --socket=/paas/iddbs/liuli/mysql01/mysql/21000/mysql.sock --incremental /paas/iddbs/liuli/mysql01/mysql/data/pxb/inc --incremental-basedir=/paas/iddbs/liuli/mysql01/mysql/data/pxb/inc/2019-10-12_15-04-18/ --parallel=2\n")])])]),t("p",[t("em",[t("strong",[a._v("增量恢复操作")])])]),a._v(" "),t("p",[t("em",[a._v("增量备份的恢复需要有3个步骤")])]),a._v(" "),t("ol",[t("li",[t("em",[a._v("恢复完全备份")])]),a._v(" "),t("li",[t("em",[a._v("恢复增量备份到完全备份(开始恢复的增量备份要添加--redo-only参数，到最后一次增量备份要去掉--redo-only)")])]),a._v(" "),t("li",[t("em",[a._v("对整体的完全备份进行恢复，回滚未提交的数据")])])]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v(" ##准备一个全备##\n[iddbs@host-172-18-231-117 pxb] innobackupex --apply-log --redo-only /paas/iddbs/liuli/mysql01/mysql/data/pxb/2019-10-12_11-44-11/\nxtrabackup: starting shutdown with innodb_fast_shutdown = 1\nInnoDB: Starting shutdown...\nInnoDB: Shutdown completed; log sequence number 2637873\nInnoDB: Number of pools: 1\n191012 14:41:30 completed OK!\n\n ##将增量1应用到完全备份##\n[iddbs@host-172-18-231-117 pxb] innobackupex --apply-log --redo-only /paas/iddbs/liuli/mysql01/mysql/data/pxb/2019-10-12_11-44-11 --incremental-dir=/paas/iddbs/liuli/mysql01/mysql/data/pxb/inc/2019-10-12_15-04-18\n\n ##将增量2应用到完全备份，注意不加 --redo-only 参数了##\n[iddbs@host-172-18-231-117 pxb] innobackupex --apply-log /paas/iddbs/liuli/mysql01/mysql/data/pxb/2019-10-12_11-44-11 --incremental-dir=/paas/iddbs/liuli/mysql01/mysql/data/pxb/inc/2019-10-12_15-05-35\n\n ##把所有合在一起的完全备份整体进行一次apply操作，回滚未提交的数据##\n[iddbs@host-172-18-231-117 pxb] innobackupex --apply-log /paas/iddbs/liuli/mysql01/mysql/data/pxb/2019-10-12_11-44-11/\n")])])]),t("p",[a._v("​\t\t"),t("strong",[a._v("全量恢复")])]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("innobackupex --defaults-file=/paas/iddbs/liuli/mysql01/mysql/etc/21000my.cnf --copy-back --rsync /paas/iddbs/liuli/mysql01/mysql/data/pxb/2019-10-12_11-44-11/\n\n")])])])])},[],!1,null,null,null);s.default=n.exports}}]);